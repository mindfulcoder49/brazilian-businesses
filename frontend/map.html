<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brazilian Businesses Map â€” Boston</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f1117; --surface: #1a1d27; --border: #2d3048;
      --accent: #00e676; --accent2: #ffca28; --warn: #ffa726;
      --danger: #ef5350; --text: #e8eaf6; --muted: #7986cb;
      --code-bg: #12141e;
      --font-ui: "Inter", system-ui, sans-serif;
      --font-mono: "JetBrains Mono", "Fira Code", monospace;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--font-ui);
           font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* â”€â”€ Header â”€â”€ */
    header {
      display: flex; align-items: center; gap: 12px; padding: 9px 16px;
      background: var(--surface); border-bottom: 1px solid var(--border);
      flex-shrink: 0; flex-wrap: wrap;
    }
    header h1 { font-size: 16px; font-weight: 700; white-space: nowrap; }
    .nav-link {
      color: var(--accent2); text-decoration: none; font-size: 12px; white-space: nowrap;
      padding: 3px 8px; border: 1px solid transparent; border-radius: 4px;
      transition: border-color 0.15s;
    }
    .nav-link:hover { border-color: var(--border); }
    #header-count { margin-left: auto; font-size: 12px; color: var(--muted); }

    /* â”€â”€ Sidebar â”€â”€ */
    #sidebar {
      position: absolute; top: 52px; left: 0; bottom: 0; z-index: 1000;
      width: 300px; background: rgba(15,17,23,0.96); border-right: 1px solid var(--border);
      backdrop-filter: blur(6px);
      display: flex; flex-direction: column; gap: 0;
      overflow-y: auto;
    }

    .sb-section {
      padding: 12px 14px; border-bottom: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 8px;
    }
    .sb-label {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.08em; color: var(--muted);
    }

    /* Threshold slider */
    #threshold-row { display: flex; align-items: center; gap: 8px; }
    #threshold-slider { flex: 1; accent-color: var(--accent); cursor: pointer; }
    #threshold-value {
      font-family: var(--font-mono); font-size: 18px; font-weight: 700;
      color: var(--accent); min-width: 36px; text-align: right;
    }
    .threshold-presets { display: flex; gap: 5px; flex-wrap: wrap; }
    .preset-btn {
      padding: 3px 9px; border: 1px solid var(--border); border-radius: 4px;
      background: transparent; color: var(--muted); font-size: 11px; cursor: pointer;
      transition: all 0.15s;
    }
    .preset-btn:hover, .preset-btn.active {
      background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700;
    }

    /* Score distribution bars */
    .score-dist { display: flex; flex-direction: column; gap: 5px; }
    .dist-row { display: grid; grid-template-columns: 80px 1fr 32px; gap: 6px; align-items: center; }
    .dist-label { font-size: 10px; color: var(--muted); }
    .dist-bar-wrap { height: 8px; background: #1a1d27; border-radius: 4px; overflow: hidden; }
    .dist-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
    .dist-count { font-family: var(--font-mono); font-size: 10px; color: var(--muted); text-align: right; }

    /* Summary numbers */
    .summary-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    }
    .sum-box {
      background: var(--code-bg); border: 1px solid var(--border); border-radius: 6px;
      padding: 8px 10px; text-align: center;
    }
    .sum-val { font-family: var(--font-mono); font-size: 20px; font-weight: 700; color: var(--accent); }
    .sum-lbl { font-size: 10px; color: var(--muted); margin-top: 2px; text-transform: uppercase; }

    /* Top types */
    .type-list { display: flex; flex-direction: column; gap: 4px; }
    .type-row { display: flex; align-items: center; gap: 6px; }
    .type-name {
      font-size: 10px; color: var(--text); flex: 1;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .type-bar-wrap { width: 60px; height: 6px; background: #1a1d27; border-radius: 3px; overflow: hidden; flex-shrink: 0; }
    .type-bar { height: 100%; background: var(--muted); border-radius: 3px; transition: width 0.4s; }
    .type-count { font-family: var(--font-mono); font-size: 10px; color: var(--muted); min-width: 20px; text-align: right; }

    /* Legend */
    .legend-grid { display: grid; grid-template-columns: 10px 1fr; gap: 3px 7px; align-items: center; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .legend-label { font-size: 10px; color: var(--muted); }

    /* Buttons */
    .btn-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .btn { padding: 6px 11px; border: none; border-radius: 5px; font-size: 12px;
           font-weight: 600; cursor: pointer; transition: opacity 0.15s; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn:not(:disabled):hover { opacity: 0.82; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: #2d3048; color: var(--text); }
    .btn-share { background: #1a2040; color: var(--accent2); border: 1px solid var(--border); }

    #score-status { font-size: 10px; color: var(--muted); }

    /* Share toast */
    #share-toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #1b3a2f; color: var(--accent); border: 1px solid var(--accent);
      border-radius: 6px; padding: 8px 18px; font-size: 13px; font-weight: 600;
      opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 9999;
    }
    #share-toast.visible { opacity: 1; }

    /* Map fills the rest */
    #map-wrap { flex: 1; position: relative; }
    #map { position: absolute; top: 0; left: 300px; right: 0; bottom: 0; }

    /* Leaflet popup dark theme */
    .leaflet-popup-content-wrapper {
      background: #1a1d27 !important; color: #e8eaf6 !important;
      border: 1px solid #2d3048 !important; border-radius: 8px !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
    }
    .leaflet-popup-tip { background: #1a1d27 !important; }
    .leaflet-popup-content { margin: 12px 14px !important; }

    .pop-name   { font-weight: 700; font-size: 14px; margin-bottom: 3px; }
    .pop-addr   { font-size: 11px; color: #90a4ae; margin-bottom: 8px; line-height: 1.4; }
    .pop-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 6px; align-items: center; }
    .pop-score  { font-family: var(--font-mono); font-weight: 700; font-size: 14px;
                  border-radius: 4px; padding: 2px 8px; }
    .pop-hit    { background: #1b3a2f; color: #00e676; border-radius: 3px;
                  padding: 2px 6px; font-size: 11px; font-weight: 700; }
    .pop-type   { background: #1a2040; color: #7986cb; border-radius: 3px;
                  padding: 1px 5px; font-size: 10px; }
    .pop-reason { font-size: 11px; color: #b0bec5; font-style: italic; margin-bottom: 6px; line-height: 1.4; }
    .pop-queries { font-size: 10px; color: #546e7a; margin-bottom: 5px; }
    .pop-query-pill { display: inline-block; background: #12141e; border: 1px solid #2d3048;
                      border-radius: 3px; padding: 1px 4px; margin: 1px; }
    .pop-gmaps  { color: #ffca28; font-size: 12px; text-decoration: none; display: block; margin-top: 5px; }
    .pop-gmaps:hover { text-decoration: underline; }

    /* â”€â”€ Cluster overrides â€” dark theme â”€â”€ */
    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
      background-color: rgba(30, 40, 55, 0.6);
    }
    .marker-cluster-small div,
    .marker-cluster-medium div,
    .marker-cluster-large div {
      background-color: rgba(20, 90, 70, 0.85);
      color: #e0f2f1;
      font-weight: 700;
    }

    /* Scrollbar */
    #sidebar::-webkit-scrollbar { width: 4px; }
    #sidebar::-webkit-scrollbar-track { background: transparent; }
    #sidebar::-webkit-scrollbar-thumb { background: #2d3048; border-radius: 2px; }
  </style>
</head>
<body>

<header>
  <h1>ðŸ‡§ðŸ‡· Brazilian Businesses â€” Boston Metro</h1>
  <a class="nav-link" href="/how-it-works">How This Works</a>
  <a class="nav-link" href="/admin">Admin â†—</a>
  <span id="header-count">Loadingâ€¦</span>
</header>

<div id="map-wrap">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <div id="sidebar">

    <!-- Score threshold -->
    <div class="sb-section">
      <div class="sb-label">Score Threshold</div>
      <div id="threshold-row">
        <input type="range" id="threshold-slider" min="0" max="95" step="5" value="75" />
        <span id="threshold-value">75</span>
      </div>
      <div class="threshold-presets">
        <button class="preset-btn" data-val="0">All</button>
        <button class="preset-btn" data-val="50">50+</button>
        <button class="preset-btn active" data-val="75">75+</button>
        <button class="preset-btn" data-val="90">90+</button>
      </div>
    </div>

    <!-- Summary counts -->
    <div class="sb-section">
      <div class="sb-label">Coverage</div>
      <div class="summary-grid">
        <div class="sum-box"><div class="sum-val" id="sum-total">â€”</div><div class="sum-lbl">Found</div></div>
        <div class="sum-box"><div class="sum-val" id="sum-enriched">â€”</div><div class="sum-lbl">Mapped</div></div>
        <div class="sum-box"><div class="sum-val" id="sum-scored">â€”</div><div class="sum-lbl">Scored</div></div>
        <div class="sum-box"><div class="sum-val" id="sum-high">â€”</div><div class="sum-lbl">High â‰¥75</div></div>
      </div>
    </div>

    <!-- Score distribution -->
    <div class="sb-section">
      <div class="sb-label">Score Distribution</div>
      <div class="score-dist" id="score-dist">
        <div class="dist-row"><span class="dist-label">90â€“100 Â· Sure</span><div class="dist-bar-wrap"><div class="dist-bar" id="bar-90" style="background:#00c853;width:0%"></div></div><span class="dist-count" id="cnt-90">â€”</span></div>
        <div class="dist-row"><span class="dist-label">75â€“89 Â· High</span><div class="dist-bar-wrap"><div class="dist-bar" id="bar-75" style="background:#43a047;width:0%"></div></div><span class="dist-count" id="cnt-75">â€”</span></div>
        <div class="dist-row"><span class="dist-label">50â€“74 Â· Moderate</span><div class="dist-bar-wrap"><div class="dist-bar" id="bar-50" style="background:#f57c00;width:0%"></div></div><span class="dist-count" id="cnt-50">â€”</span></div>
        <div class="dist-row"><span class="dist-label">20â€“49 Â· Weak</span><div class="dist-bar-wrap"><div class="dist-bar" id="bar-20" style="background:#e53935;width:0%"></div></div><span class="dist-count" id="cnt-20">â€”</span></div>
        <div class="dist-row"><span class="dist-label">1â€“19 Â· Unlikely</span><div class="dist-bar-wrap"><div class="dist-bar" id="bar-1" style="background:#880e4f;width:0%"></div></div><span class="dist-count" id="cnt-1">â€”</span></div>
        <div class="dist-row"><span class="dist-label">Not scored</span><div class="dist-bar-wrap"><div class="dist-bar" id="bar-ns" style="background:#455a64;width:0%"></div></div><span class="dist-count" id="cnt-ns">â€”</span></div>
      </div>
    </div>

    <!-- Top business types -->
    <div class="sb-section">
      <div class="sb-label">Top Business Types</div>
      <div class="type-list" id="type-list">
        <div style="font-size:11px;color:var(--muted)">Loadingâ€¦</div>
      </div>
    </div>

    <!-- Search coverage -->
    <div class="sb-section">
      <div class="sb-label">Search Coverage</div>
      <div class="summary-grid">
        <div class="sum-box"><div class="sum-val" id="sum-queries">â€”</div><div class="sum-lbl">Queries</div></div>
        <div class="sum-box"><div class="sum-val" id="sum-dupes">â€”</div><div class="sum-lbl">Dupes Dropped</div></div>
      </div>
    </div>

    <!-- Score legend -->
    <div class="sb-section">
      <div class="sb-label">Legend</div>
      <div class="legend-grid">
        <div class="legend-dot" style="background:#00c853"></div><div class="legend-label">90â€“100 Â· Unmistakably Brazilian</div>
        <div class="legend-dot" style="background:#43a047"></div><div class="legend-label">75â€“89 Â· High confidence</div>
        <div class="legend-dot" style="background:#f57c00"></div><div class="legend-label">50â€“74 Â· Moderate</div>
        <div class="legend-dot" style="background:#e53935"></div><div class="legend-label">20â€“49 Â· Weak indicators</div>
        <div class="legend-dot" style="background:#880e4f"></div><div class="legend-label">1â€“19 Â· Probably not</div>
        <div class="legend-dot" style="background:#455a64"></div><div class="legend-label">Not scored yet</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="sb-section">
      <div class="sb-label">Actions</div>
      <div class="btn-row">
        <button class="btn btn-primary" id="btn-score">Score Unscored</button>
        <button class="btn btn-secondary" id="btn-reload">â†» Reload</button>
      </div>
      <button class="btn btn-share" id="btn-share">ðŸ”— Share this view</button>
      <div id="score-status"></div>
    </div>

  </div>

  <div id="map"></div>
</div>

<div id="share-toast">Link copied to clipboard!</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// â”€â”€ Map init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { center: [42.3601, -71.0589], zoom: 12 });

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  maxZoom: 19,
}).addTo(map);

const clusterGroup = L.markerClusterGroup({ maxClusterRadius: 50 });
map.addLayer(clusterGroup);

// â”€â”€ Score â†’ color / size â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scoreColor(score) {
  if (score === null || score === undefined) return '#455a64';
  if (score >= 90) return '#00c853';
  if (score >= 75) return '#43a047';
  if (score >= 50) return '#f57c00';
  if (score >= 20) return '#e53935';
  return '#880e4f';
}

function markerSize(score) {
  if (score === null || score === undefined) return 10;
  if (score >= 90) return 16;
  if (score >= 75) return 14;
  if (score >= 50) return 12;
  return 10;
}

function makeIcon(score) {
  const color = scoreColor(score);
  const size = markerSize(score);
  return L.divIcon({
    className: '',
    html: `<div style="width:${size}px;height:${size}px;border-radius:50%;
           background:${color};border:2px solid rgba(255,255,255,0.55);
           box-shadow:0 0 5px rgba(0,0,0,0.45)"></div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
  });
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function scoreLabel(score) {
  if (score === null || score === undefined) return '<span style="color:#546e7a">not scored</span>';
  const color = scoreColor(score);
  return `<span class="pop-score" style="background:${color}22;color:${color}">${score}</span>`;
}

// â”€â”€ Render markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allPlaces = [];

function renderMarkers() {
  clusterGroup.clearLayers();

  allPlaces.forEach(p => {
    if (!p.latitude || !p.longitude) return;

    const queries = (p.query_sources || []).slice(0, 6)
      .map(s => `<span class="pop-query-pill">${escHtml(s)}</span>`).join('');
    const extra = p.query_sources && p.query_sources.length > 6
      ? `<span class="pop-query-pill">+${p.query_sources.length - 6}</span>` : '';

    const popup = `
      <div class="pop-name">${escHtml(p.display_name || '(unknown)')}</div>
      <div class="pop-addr">${escHtml(p.formatted_address || '')}</div>
      <div class="pop-badges">
        ${scoreLabel(p.brazil_score)}
        <span class="pop-hit">${p.hit_count} hit${p.hit_count!==1?'s':''}</span>
        ${p.primary_type ? `<span class="pop-type">${escHtml(p.primary_type)}</span>` : ''}
      </div>
      ${p.score_reason ? `<div class="pop-reason">"${escHtml(p.score_reason)}"</div>` : ''}
      <div class="pop-queries">Matched by: ${queries}${extra}</div>
      ${p.google_maps_uri
        ? `<a class="pop-gmaps" href="${escHtml(p.google_maps_uri)}" target="_blank" rel="noreferrer">Open in Google Maps â†—</a>`
        : ''}
    `;

    L.marker([p.latitude, p.longitude], { icon: makeIcon(p.brazil_score) })
     .bindPopup(popup, { maxWidth: 300 })
     .addTo(clusterGroup);
  });

  const threshold = getThreshold();
  document.getElementById('header-count').textContent =
    `${allPlaces.length} places${threshold > 0 ? ` (score â‰¥ ${threshold})` : ''}`;
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlaces() {
  const threshold = getThreshold();
  const url = `/api/candidates/map${threshold > 0 ? `?min_score=${threshold}` : ''}`;
  const res = await fetch(url);
  const data = await res.json();
  allPlaces = data.places || [];
  renderMarkers();
}

// â”€â”€ Load overview stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOverview() {
  try {
    const res = await fetch('/api/stats/overview');
    const data = await res.json();
    const c = data.counts || {};
    const qt = data.query_stats || {};

    // Summary boxes
    document.getElementById('sum-total').textContent = c.total_candidates || 0;
    document.getElementById('sum-enriched').textContent = c.enriched || 0;
    document.getElementById('sum-scored').textContent = c.scored || 0;
    document.getElementById('sum-high').textContent = (c.score_90_plus||0) + (c.score_75_89||0);

    // Score distribution bars
    const enriched = c.enriched || 1;  // avoid div-by-zero
    const bars = [
      ['90', c.score_90_plus, '#00c853'],
      ['75', c.score_75_89,   '#43a047'],
      ['50', c.score_50_74,   '#f57c00'],
      ['20', c.score_20_49,   '#e53935'],
      ['1',  c.score_1_19,    '#880e4f'],
      ['ns', c.unscored,      '#455a64'],
    ];
    bars.forEach(([key, val, color]) => {
      const n = val || 0;
      const pct = Math.round(n / enriched * 100);
      const barEl = document.getElementById(`bar-${key}`);
      const cntEl = document.getElementById(`cnt-${key}`);
      if (barEl) { barEl.style.width = `${pct}%`; barEl.style.background = color; }
      if (cntEl) cntEl.textContent = n;
    });

    // Top types
    const typeList = document.getElementById('type-list');
    const types = data.top_types || [];
    if (types.length === 0) {
      typeList.innerHTML = '<div style="font-size:11px;color:var(--muted)">No data yet</div>';
    } else {
      const maxCount = types[0].count || 1;
      typeList.innerHTML = types.map(t => {
        const pct = Math.round(t.count / maxCount * 100);
        const label = t.type.replace(/_/g, ' ');
        return `<div class="type-row">
          <span class="type-name" title="${escHtml(t.type)}">${escHtml(label)}</span>
          <div class="type-bar-wrap"><div class="type-bar" style="width:${pct}%"></div></div>
          <span class="type-count">${t.count}</span>
        </div>`;
      }).join('');
    }

    // Search coverage
    document.getElementById('sum-queries').textContent = qt.total_queries_run || 0;
    document.getElementById('sum-dupes').textContent = qt.duplicates_dropped || 0;

  } catch (e) {
    console.warn('Overview load failed', e);
  }
}

// â”€â”€ Threshold controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getThreshold() {
  return parseInt(document.getElementById('threshold-slider').value, 10);
}

function setThreshold(val) {
  val = Math.max(0, Math.min(95, parseInt(val, 10) || 0));
  document.getElementById('threshold-slider').value = val;
  document.getElementById('threshold-value').textContent = val;
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.val) === val);
  });
  updateHash(val);
  loadPlaces();
}

document.getElementById('threshold-slider').addEventListener('input', e => {
  const val = parseInt(e.target.value);
  document.getElementById('threshold-value').textContent = val;
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.val) === val);
  });
});
document.getElementById('threshold-slider').addEventListener('change', e => {
  updateHash(parseInt(e.target.value));
  loadPlaces();
});

document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => setThreshold(parseInt(btn.dataset.val)));
});

// â”€â”€ URL hash for shareable views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHash(threshold) {
  if (threshold > 0) {
    history.replaceState(null, '', `#min=${threshold}`);
  } else {
    history.replaceState(null, '', location.pathname);
  }
}

function readHashThreshold() {
  const m = location.hash.match(/[#&]min=(\d+)/);
  return m ? parseInt(m[1]) : null;  // null = no hash present (use default)
}

document.getElementById('btn-share').addEventListener('click', () => {
  const url = location.href.split('#')[0] + `#min=${getThreshold()}`;
  navigator.clipboard.writeText(url).catch(() => {});
  const toast = document.getElementById('share-toast');
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 2200);
});

// â”€â”€ Scoring controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scorePollInterval = null;

async function checkScoreStatus() {
  const res = await fetch('/api/score/status');
  const data = await res.json();
  const s = data.scores || {};
  const prog = data.progress || {};
  const statusEl = document.getElementById('score-status');

  statusEl.textContent = `Scored: ${s.scored||0} / ${s.total||0} Â· High: ${s.high_confidence||0} Â· Pending: ${s.pending||0}`;

  const btn = document.getElementById('btn-score');
  if (data.running) {
    btn.disabled = true;
    btn.textContent = prog.total > 0 ? `â³ ${prog.done}/${prog.total}` : 'â³ Scoringâ€¦';
    if (!scorePollInterval) {
      scorePollInterval = setInterval(async () => {
        await checkScoreStatus();
        await loadPlaces();
        await loadOverview();
      }, 4000);
    }
  } else {
    if (scorePollInterval) { clearInterval(scorePollInterval); scorePollInterval = null; }
    btn.disabled = s.pending === 0;
    btn.textContent = s.pending > 0 ? `Score ${s.pending} Pending` : 'All Scored âœ“';
  }
}

document.getElementById('btn-score').addEventListener('click', async () => {
  document.getElementById('btn-score').disabled = true;
  document.getElementById('btn-score').textContent = 'Startingâ€¦';
  await fetch('/api/score', { method: 'POST' });
  await checkScoreStatus();
});

document.getElementById('btn-reload').addEventListener('click', async () => {
  await loadPlaces();
  await loadOverview();
  await checkScoreStatus();
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const hashThreshold = readHashThreshold();
  const initialThreshold = hashThreshold !== null ? hashThreshold : 75;  // default 75

  document.getElementById('threshold-slider').value = initialThreshold;
  document.getElementById('threshold-value').textContent = initialThreshold;
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.val) === initialThreshold);
  });

  await Promise.all([loadPlaces(), loadOverview(), checkScoreStatus()]);
})();
</script>
</body>
</html>
